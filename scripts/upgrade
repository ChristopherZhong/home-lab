#!/bin/bash

# Script to upgrade K3s to the latest stable version
# Usage: ./upgrade

# set -euo pipefail: Enable strict error handling in the script
# -e: Exit immediately if any command fails (non-zero exit status)
# -u: Treat references to unset variables as errors
# -o pipefail: Cause pipelines to fail if any command in the pipeline fails
set -euo pipefail

echo "Upgrading K3s to the latest stable version..."

# Optional: Backup datastore (uncomment if needed)
# echo "Backing up K3s datastore..."
# sudo cp -r /var/lib/rancher/k3s/server/db /var/lib/rancher/k3s/server/db-backup-$(date +%Y%m%d-%H%M%S)

# Stop K3s if necessary (the install script handles restart)
sudo systemctl stop k3s

# Upgrade to latest stable
# curl --silent --fail --location: Download options for the K3s install script
# --silent: Silent mode, suppress progress meter and error messages
# --fail: Fail fast on HTTP errors (4xx/5xx), exit with non-zero status
# --location: Follow HTTP redirects automatically
curl --silent --fail --location https://get.k3s.io | sh -

# Ensure K3s service is started after upgrade
sudo systemctl start k3s

# Wait for K3s to start
echo "Waiting for K3s to restart..."
# Poll until kubectl get nodes succeeds, indicating K3s API is ready
# Redirect stdout and stderr to /dev/null to suppress output, rely on exit code
while ! sudo kubectl get nodes >/dev/null 2>&1; do
  echo "K3s not ready yet, waiting..."
  sleep 2
done

# Validate upgrade
echo "Validating upgrade..."
k3s --version
sudo kubectl get nodes
# kubectl get pods --all-namespaces | head --lines=20: List pods across all namespaces and limit output to first 20 lines
# --all-namespaces: Include pods from all namespaces for a comprehensive view
# head --lines=20: Display only the first 20 lines to avoid excessive output while checking pod status
sudo kubectl get pods --all-namespaces | head --lines=20

echo "K3s upgrade completed successfully."