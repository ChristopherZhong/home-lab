#!/bin/bash

# Initialization script for home-lab

# set -euo pipefail: Enable strict error handling in the script
# -e: Exit immediately if any command fails (non-zero exit status)
# -u: Treat references to unset variables as errors
# -o pipefail: Cause pipelines to fail if any command in the pipeline fails
set -euo pipefail

# Mode: set to "server" (default) or "agent"
# For agent mode, also set K3S_URL and K3S_TOKEN environment variables
MODE=${MODE:-server}

echo "Initializing home-lab in $MODE mode..."

# Configure k3s installation
if [ "$MODE" = "agent" ]; then
  export INSTALL_K3S_EXEC=agent
  if [ -z "${K3S_URL:-}" ] || [ -z "${K3S_TOKEN:-}" ]; then
    echo "Error: For agent mode, K3S_URL and K3S_TOKEN must be set."
    exit 1
  fi
fi

# Install k3s
# curl --silent --fail --location: Download options for the K3s install script
# --silent: Silent mode, suppress progress meter and error messages
# --fail: Fail fast on HTTP errors (4xx/5xx), exit with non-zero status
# --location: Follow HTTP redirects automatically
curl --silent --fail --location https://get.k3s.io | sh -

# Verify installation
if [ "$MODE" = "server" ]; then
  sudo kubectl get nodes
  sudo kubectl get all --all-namespaces
fi

echo "Initialization complete!"
